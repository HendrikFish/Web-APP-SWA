import"./bootstrap.esm-DGoQCxh1.js";import{i as C}from"./header-DaFr1czl.js";/* empty css               */import{showToast as u}from"./toast-notification-BBb3bACE.js";function N(){console.log("üîó Men√º-Portal API initialisiert")}async function H(){try{const e=await fetch("/api/portal/stammdaten",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const n=await e.json();if(!n.success)throw new Error(n.message||"Fehler beim Laden der Portal-Stammdaten");return{success:!0,stammdaten:n.stammdaten}}catch(e){return console.error("‚ùå Fehler beim Laden der Portal-Stammdaten:",e),{success:!1,message:"Fehler beim Laden der Portal-Stammdaten"}}}async function U(e,n,t){var r;try{console.log(`üìÖ Lade Men√ºplan: Einrichtung ${e}, KW ${t}/${n}`);const s=await fetch(`/api/menueplan?einrichtung=${e}&year=${n}&week=${t}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const o=await s.json();if(o.error)throw new Error(o.error);const i=q(o,n,t),a=G(i);return console.log(`‚úÖ Men√ºplan geladen: ${a} Rezepte f√ºr ${((r=o.einrichtung)==null?void 0:r.name)||"Unbekannte Einrichtung"}`),{success:!0,menuplan:i,einrichtung:o.einrichtung}}catch(s){return console.error("‚ùå Fehler beim Laden des Men√ºplans:",s),{success:!1,message:"Fehler beim Laden des Men√ºplans. Bitte versuchen Sie es erneut."}}}async function O(e){try{if(!e||e.length===0)return{success:!0,rezepte:[]};console.log(`üçΩÔ∏è Lade ${e.length} Rezept(e)...`);const n=await fetch("/api/rezepte",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=(await n.json()).filter(s=>e.includes(s.id));return console.log(`‚úÖ ${r.length} Rezept(e) geladen`),{success:!0,rezepte:r}}catch(n){return console.error("‚ùå Fehler beim Laden der Rezepte:",n),{success:!1,message:"Fehler beim Laden der Rezepte"}}}function Y(e,n){const t=["montag","dienstag","mittwoch","donnerstag","freitag","samstag","sonntag"],r=["suppe","menu1","menu2","dessert","abend"],s={id:`${e}-${n}`,year:e,week:n,days:{}};return t.forEach(o=>{s.days[o]={},r.forEach(i=>{s.days[o][i]=[]})}),s}function q(e,n,t){var p;if(!e||!e.menuplan||!e.menuplan.days)return Y(n,t);const r=e.menuplan,s=["montag","dienstag","mittwoch","donnerstag","freitag","samstag","sonntag"],o=new Set;s.forEach(c=>{r.days[c]&&r.days[c].Mahlzeiten&&Object.keys(r.days[c].Mahlzeiten).forEach(h=>{o.add(h)})});const i=Array.from(o),a={id:r.id||`${n}-${t}`,year:r.year||n,week:r.week||t,einrichtungstyp:(p=e.einrichtung)!=null&&p.isIntern?"intern":"extern",sichtbare_kategorien:i,kategorien:e.kategorien||{},isPlaceholder:e.isPlaceholder||!1,days:{}};return s.forEach(c=>{a.days[c]={},i.forEach(h=>{r.days[c]&&r.days[c].Mahlzeiten&&Array.isArray(r.days[c].Mahlzeiten[h])?a.days[c][h]=r.days[c].Mahlzeiten[h]:a.days[c][h]=[]})}),a}function G(e){let n=0;return Object.keys(e.days||{}).forEach(r=>{Object.keys(e.days[r]||{}).forEach(o=>{const i=e.days[r][o]||[];n+=i.length})}),n}function _(e){const n=new Set;return Object.keys(e.days||{}).forEach(r=>{Object.keys(e.days[r]||{}).forEach(o=>{(e.days[r][o]||[]).forEach(a=>{a&&a.id&&n.add(a.id)})})}),Array.from(n)}function v(e,n){const t=new Date(e,0,4),r=1-t.getDay()||-6,s=new Date(t.getTime()+r*24*60*60*1e3);return new Date(s.getTime()+(n-1)*7*24*60*60*1e3)}function w(e){const n=String(e.getDate()).padStart(2,"0"),t=String(e.getMonth()+1).padStart(2,"0"),r=e.getFullYear();return`${n}.${t}.${r}`}function B(e){return{montag:"Montag",dienstag:"Dienstag",mittwoch:"Mittwoch",donnerstag:"Donnerstag",freitag:"Freitag",samstag:"Samstag",sonntag:"Sonntag"}[e]||e}function I(e,n=null){var r,s;return(s=(r=n==null?void 0:n.kategorie_namen)==null?void 0:r.namen)!=null&&s[e]?n.kategorie_namen.namen[e]:{suppe:"Suppe",menu1:"Men√º 1",menu2:"Men√º 2",menu:"Men√º",dessert:"Dessert",abend:"Abendessen","abend-suppe":"Abend-Suppe",milchspeise:"Milchspeise",normalkost:"Normalkost","kalte-platte":"Kalte Platte","wurstbrot-toast":"Wurstbrot (Toast)","wurstbrot-schwarzbrot":"Wurstbrot (Schwarzbrot)","kaesebrot-toast":"K√§sebrot (Toast)","kaesebrot-schwarzbrot":"K√§sebrot (Schwarzbrot)"}[e]||e}function S(e,n=null){var r,s;return(s=(r=n==null?void 0:n.kategorie_icons)==null?void 0:r.icons)!=null&&s[e]?n.kategorie_icons.icons[e]:{suppe:"üç≤",menu1:"üçΩÔ∏è",menu2:"ü•ò",menu:"üçΩÔ∏è",dessert:"üç∞",abend:"üç¥","abend-suppe":"üç≤",milchspeise:"ü•õ",normalkost:"ü•ó","kalte-platte":"üßÄ","wurstbrot-toast":"ü•™","wurstbrot-schwarzbrot":"ü•ñ","kaesebrot-toast":"üßÄ","kaesebrot-schwarzbrot":"üßÄ"}[e]||"üçΩÔ∏è"}async function K(){try{console.log("üîê Authentifizierung wird gepr√ºft...");const e=await J();if(!e.success)return{success:!1,message:"Bitte melden Sie sich an, um das Men√º-Portal zu nutzen."};const n=e.user;if(console.log("üë§ Benutzer:",n.firstName,n.lastName,"(",n.email,")"),!n.einrichtungen||n.einrichtungen.length===0)return{success:!1,message:"Ihrem Benutzer sind keine Einrichtungen zugeordnet. Kontaktieren Sie einen Administrator."};const t=await V(n.einrichtungen);return t.length===0?{success:!1,message:"Keine g√ºltigen Einrichtungen gefunden. Kontaktieren Sie einen Administrator."}:(console.log(`üè¢ ${t.length} Einrichtung(en) geladen:`,t.map(r=>r.name)),window.currentUser=n,window.currentEinrichtungen=t,{success:!0,user:n,einrichtungen:t})}catch(e){return console.error("‚ùå Fehler bei der Authentifizierung:",e),{success:!1,message:"Fehler beim Laden der Benutzerdaten. Bitte versuchen Sie es erneut."}}}async function J(){try{const e=await fetch("/api/user/current",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!e.ok){if(e.status===401)return localStorage.removeItem("token"),window.location.href="/frontend/core/login/",{success:!1,message:"Sitzung abgelaufen"};throw new Error(`HTTP ${e.status}: ${e.statusText}`)}return{success:!0,user:await e.json()}}catch(e){return console.error("Fehler beim Laden des Benutzers:",e),localStorage.getItem("token")||(window.location.href="/frontend/core/login/"),{success:!1,message:"Fehler beim Laden der Benutzerdaten"}}}async function V(e){try{console.log("üè¢ Lade Details f√ºr Einrichtungen:",e);const n=[],t=e.map(async s=>{try{const o=`/api/einrichtungen/${s}`;console.log("üîó Lade Einrichtung von URL:",o);const i=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});return i.ok?await i.json():(console.warn(`Einrichtung ${s} konnte nicht geladen werden:`,i.status),null)}catch(o){return console.warn(`Fehler beim Laden der Einrichtung ${s}:`,o),null}});return(await Promise.all(t)).forEach(s=>{s&&s.id&&n.push(s)}),n}catch(n){return console.error("Fehler beim Laden der Einrichtungsdetails:",n),[]}}function Q(){const e=window.currentEinrichtungen||[];return e.length>0?e[0]:null}function X(){return window.currentEinrichtungen||[]}let l=null,d=new Date().getFullYear(),g=M(new Date),m=null,P={},x=!1,f=null;async function Z(e,n){try{console.log("üé® Men√º-Portal UI wird initialisiert...");const t=await H();t.success&&(f=t.stammdaten),E(),$(),ee(n),ne(),te(),l=Q(),l&&await y(),console.log("‚úÖ Men√º-Portal UI initialisiert")}catch(t){console.error("‚ùå Fehler bei UI-Initialisierung:",t),u("Fehler beim Initialisieren der Benutzeroberfl√§che","error")}}function ee(e){const n=document.getElementById("einrichtungs-selector"),t=document.getElementById("einrichtungs-info");if(!n)return;if(t&&l&&(t.innerHTML=`
            <i class="bi bi-building"></i>
            <strong>${l.name}</strong>
            <span class="badge bg-secondary ms-2">${l.kuerzel}</span>
        `),e.length<=1){n.style.display="none";return}const r=e.map(s=>`
        <button 
            type="button" 
            class="btn btn-outline-primary einrichtung-btn" 
            data-einrichtung-id="${s.id}"
        >
            ${s.name}
            <span class="badge bg-light text-dark ms-1">${s.kuerzel}</span>
        </button>
    `).join("");if(n.innerHTML=`
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="bi bi-building"></i> Einrichtung w√§hlen:
                </h6>
                <div class="btn-group-sm d-flex flex-wrap gap-2" role="group">
                    ${r}
                </div>
            </div>
        </div>
    `,n.style.display="block",n.addEventListener("click",async s=>{if(s.target.classList.contains("einrichtung-btn")){const o=s.target.dataset.einrichtungId;await re(o)}}),l){const s=n.querySelector(`[data-einrichtung-id="${l.id}"]`);s&&s.classList.add("active")}}function ne(){const e=document.getElementById("prev-week"),n=document.getElementById("next-week"),t=document.getElementById("current-week");document.getElementById("week-display"),e&&e.addEventListener("click",()=>z(-1)),n&&n.addEventListener("click",()=>z(1)),t&&t.addEventListener("click",()=>se());const r=document.getElementById("print-menu"),s=document.getElementById("export-pdf"),o=document.getElementById("refresh-menu");r&&r.addEventListener("click",R),s&&s.addEventListener("click",de),o&&o.addEventListener("click",()=>y()),k()}function te(){window.addEventListener("menue-portal:layout-change",()=>{E(),F()}),window.addEventListener("resize",()=>{setTimeout(E,100)})}async function re(e){var n;try{const r=X().find(o=>o.id===e);if(!r){u("Einrichtung nicht gefunden","error");return}l=r;const s=document.getElementById("einrichtungs-info");s&&(s.innerHTML=`
                <i class="bi bi-building"></i>
                <strong>${r.name}</strong>
                <span class="badge bg-secondary ms-2">${r.kuerzel}</span>
            `),document.querySelectorAll(".einrichtung-btn").forEach(o=>{o.classList.remove("active")}),(n=document.querySelector(`[data-einrichtung-id="${e}"]`))==null||n.classList.add("active"),await y(),u(`Einrichtung gewechselt: ${r.name}`,"success")}catch(t){console.error("Fehler beim Wechseln der Einrichtung:",t),u("Fehler beim Wechseln der Einrichtung","error")}}async function z(e){const n=g+e;let t=d;n<1?(t=d-1,g=T(t)):n>T(d)?(t=d+1,g=1):g=n,d=t,k(),await y()}async function se(){const e=new Date;d=e.getFullYear(),g=M(e),k(),await y()}async function y(){if(!l){b("Keine Einrichtung ausgew√§hlt");return}try{ue();const e=await U(l.id,d,g);if(!e.success){b(e.message);return}m=e.menuplan,window.currentMenuPlan=m,await oe(),F(),$()}catch(e){console.error("Fehler beim Laden des Men√ºplans:",e),b("Fehler beim Laden des Men√ºplans")}}async function oe(){if(m)try{const e=_(m);if(e.length===0){console.log("Keine Rezepte im Men√ºplan gefunden");return}const n=await O(e);n.success&&(n.rezepte.forEach(t=>{P[t.id]=t}),console.log(`üìã ${n.rezepte.length} Rezepte in Cache geladen`))}catch(e){console.error("Fehler beim Laden der Rezepte:",e)}}function F(){m&&(x?ie():ce())}function ie(){const e=document.getElementById("mobile-accordion");if(!e)return;const n=["montag","dienstag","mittwoch","donnerstag","freitag","samstag","sonntag"],t=m.sichtbare_kategorien||["suppe","menu1","menu2","dessert","abend"];let r='<div class="mobile-accordion">';n.forEach((s,o)=>{const i=m.days[s]||{},a=B(s),p=v(d,g),c=new Date(p.getTime()+o*24*60*60*1e3),h=w(c),L=t.reduce((W,j)=>W+(i[j]||[]).length,0);r+=`
            <div class="day-accordion-section">
                <div class="day-header" data-day="${s}">
                    <div class="day-title">
                        <span>${a}</span>
                        <small class="text-light">${h}</small>
                        <span class="day-counter">${L} Rezept${L!==1?"e":""}</span>
                    </div>
                    <i class="bi bi-chevron-down day-toggle-icon"></i>
                </div>
                
                <div class="day-content" data-day="${s}">
                    ${ae(i,t)}
                </div>
            </div>
        `}),r+="</div>",e.innerHTML=r,le()}function ae(e,n){let t="";return n.forEach(r=>{const s=e[r]||[],o=I(r,f),i=S(r,f);t+=`
            <div class="category-section">
                <div class="category-title">
                    <span class="category-icon">${i}</span>
                    ${o}
                </div>
                <div class="recipe-list">
                    ${A(s)}
                </div>
            </div>
        `}),t}function ce(){const e=document.getElementById("desktop-grid");if(!e)return;const n=["montag","dienstag","mittwoch","donnerstag","freitag","samstag","sonntag"],t=m.sichtbare_kategorien||["suppe","menu1","menu2","dessert","abend"];let r='<div class="desktop-grid">';r+='<div class="grid-header-cell grid-corner-cell">Kategorie</div>',n.forEach((s,o)=>{const i=B(s),a=v(d,g),p=new Date(a.getTime()+o*24*60*60*1e3),c=w(p);r+=`
            <div class="grid-header-cell">
                <div>${i}</div>
                <small class="text-muted">${c}</small>
            </div>
        `}),t.forEach(s=>{const o=I(s,f),i=S(s,f);r+=`
            <div class="grid-kategorie-cell">
                <span style="margin-right: 8px;">${i}</span>
                ${o}
            </div>
        `,n.forEach(a=>{const c=(m.days[a]||{})[s]||[];r+=`
                <div class="grid-content-cell">
                    <div class="recipe-list">
                        ${A(c)}
                    </div>
                </div>
            `})}),r+="</div>",e.innerHTML=r}function A(e){return!e||e.length===0?'<div class="empty-category">Keine Rezepte</div>':e.map(n=>{const t=P[n.id]||n,r=t.name||"Unbekanntes Rezept",s=t.allergene||[];return`
            <div class="recipe-item">
                <div class="recipe-content">
                    <div class="recipe-name">${r}</div>
                    ${s.length>0?`
                        <div class="allergen-icons">
                            ${s.slice(0,5).map(o=>`
                                <span class="allergen-icon" title="${o}">${o.charAt(0).toUpperCase()}</span>
                            `).join("")}
                            ${s.length>5?'<span class="allergen-icon">+</span>':""}
                        </div>
                    `:""}
                </div>
            </div>
        `}).join("")}function le(){document.querySelectorAll(".day-header").forEach(e=>{e.addEventListener("click",n=>{const t=e.dataset.day,r=document.querySelector(`.day-content[data-day="${t}"]`);e.classList.contains("expanded")?(e.classList.remove("expanded"),r.classList.remove("expanded")):(e.classList.add("expanded"),r.classList.add("expanded"))})})}function E(){x=window.innerWidth<=768}function k(){const e=document.getElementById("week-display");if(e){const n=v(d,g),t=new Date(n.getTime()+6*24*60*60*1e3);e.innerHTML=`
            <strong>KW ${g}/${d}</strong><br>
            <small class="text-muted">${w(n)} - ${w(t)}</small>
        `}}function R(){if(!m||!l){u("Kein Men√ºplan zum Drucken verf√ºgbar","error");return}const e=document.title;document.title=`Men√ºplan KW ${g}/${d} - ${l.name}`,window.print(),setTimeout(()=>{document.title=e},100)}function de(){if(!m||!l){u("Kein Men√ºplan zum Exportieren verf√ºgbar","error");return}u('PDF-Export: Bitte "Als PDF speichern" im Druckdialog w√§hlen',"info"),R()}function ue(){const e=document.getElementById("loading-spinner"),n=document.getElementById("menue-portal-wrapper");e&&(e.style.display="flex"),n&&(n.style.display="none")}function $(){const e=document.getElementById("loading-spinner"),n=document.getElementById("menue-portal-wrapper");e&&(e.style.display="none"),n&&(n.style.display="block")}function b(e){$();const n=document.getElementById("error-message"),t=document.getElementById("error-text");n&&t&&(t.textContent=e,n.style.display="block"),u(e,"error")}function M(e){const n=new Date(e.getFullYear(),0,1),t=(e-n)/864e5;return Math.ceil((t+n.getDay()+1)/7)}function T(e){const n=new Date(e,11,31);return M(n)}async function ge(){try{console.log("üöÄ Men√º-Portal wird initialisiert...");const e=await C(),n=await K();if(!n.success){D(n.message);return}N(),await Z(e,n.einrichtungen),console.log("‚úÖ Men√º-Portal erfolgreich initialisiert")}catch(e){console.error("‚ùå Fehler bei der Initialisierung des Men√º-Portals:",e),D("Fehler beim Laden des Men√º-Portals. Bitte Seite neu laden.")}}function D(e){const n=document.getElementById("loading-spinner"),t=document.getElementById("error-message"),r=document.getElementById("error-text");n&&(n.style.display="none"),t&&r&&(r.textContent=e,t.style.display="block"),u(e,"error")}function me(){let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{window.dispatchEvent(new CustomEvent("menue-portal:layout-change"))},250)}),window.addEventListener("unhandledrejection",n=>{console.error("Unhandled Promise Rejection:",n.reason),u("Ein unerwarteter Fehler ist aufgetreten.","error")}),window.addEventListener("error",n=>{console.error("JavaScript Error:",n.error),u("Ein Anwendungsfehler ist aufgetreten.","error")})}async function he(){if("serviceWorker"in navigator)try{console.log("Service Worker Support verf√ºgbar")}catch(e){console.log("Service Worker Registration fehlgeschlagen:",e)}}document.addEventListener("DOMContentLoaded",()=>{console.log("üì± Men√º-Portal DOM geladen"),me(),he(),ge()});(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&(window.menuePortalDebug={reloadModules:()=>{location.reload()},showToast:(e,n="info")=>{u(e,n)},getState:()=>({user:window.currentUser,einrichtungen:window.currentEinrichtungen,menuPlan:window.currentMenuPlan})},console.log("üîß Debug-Modus aktiviert. Verwende window.menuePortalDebug"));
